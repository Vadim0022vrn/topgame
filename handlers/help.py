import asyncio
import logging
from aiogram import types  # –î–æ–±–∞–≤—å —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç
from aiogram.types import Message
from aiogram import Router, types
from aiogram.fsm.context import FSMContext
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from handlers.profile import handle_profile
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from utils.database import execute_db_query


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.INFO)

router = Router()

async def handle_help(message: types.Message):
    help_text = (
        "üåü <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!</b> üåü\n\n"
        "–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –ø—Ä–æ–π—Ç–∏ –ø—É—Ç—å –æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ —É–±–æ—Ä—â–∏–∫–∞ –¥–æ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –º–∏–ª–ª–∏–∞—Ä–¥–µ—Ä–∞! üöÄ\n\n"
        
        "üìö <b>–ß—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –¥–µ–ª–∞—Ç—å –≤ –∏–≥—Ä–µ:</b>\n\n"
        "1. <b>–ü—Ä–æ—Ö–æ–¥–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ</b> üéì ‚Äî —Ä–∞–∑–≤–∏–≤–∞–π —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞.\n"
        "2. <b>–ü–æ–∫—É–ø–∞—Ç—å –∏ —É–ª—É—á—à–∞—Ç—å –±–∏–∑–Ω–µ—Å—ã</b> üè¢ ‚Äî —Å–æ–∑–¥–∞–≤–∞–π —Å–≤–æ—é –∏–º–ø–µ—Ä–∏—é, —É–ª—É—á—à–∞–π –±–∏–∑–Ω–µ—Å—ã –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –¥–µ–Ω—å–≥–∏! üí∞\n"
        "3. <b>–†–∞–±–æ—Ç–∞—Ç—å</b> üë∑ ‚Äî —É—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è –Ω–∞ —Ä–∞–±–æ—Ç—É, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏ –ø–æ–≤—ã—à–∞—Ç—å —Å–≤–æ–π —É—Ä–æ–≤–µ–Ω—å.\n"
        "4. <b>–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</b> üìà ‚Äî –≤–∫–ª–∞–¥—ã–≤–∞–π –¥–µ–Ω—å–≥–∏ –≤ –±–∞–Ω–∫ –∏–ª–∏ –º–∞–π–Ω–∏–Ω–≥-—Ñ–µ—Ä–º—ã –¥–ª—è –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞.\n"
        "5. <b>–ü–æ–∫—É–ø–∞—Ç—å –∞–∫—Ç–∏–≤—ã</b> üöóüè†üõ•Ô∏è ‚Äî –ø—Ä–∏–æ–±—Ä–µ—Ç–∞–π –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, –¥–æ–º–∞, —è—Ö—Ç—ã –∏ –¥–∞–∂–µ –æ—Å—Ç—Ä–æ–≤–∞, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å.\n"
        "6. <b>–ü—Ä–∏–≥–ª–∞—à–∞—Ç—å –¥—Ä—É–∑–µ–π</b> üë• ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –±–æ–Ω—É—Å—ã –∑–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π.\n\n"
        
        "üî• <b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n\n"
        "/start ‚Äî –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é üéÆ\n"
        "/help ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø–æ–º–æ—â—å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ üìñ\n"
        "/–ø—Ä–æ—Ñ–∏–ª—å ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å üë§\n"
        "/rank ‚Äî —É–∑–Ω–∞—Ç—å —Å–≤–æ–π —Ä–∞–Ω–≥ üèÖ\n"
        "/daily ‚Äî –ø–æ–ª—É—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å üéÅ\n"
        "/–º–æ–π—Ä–µ—Ñ ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É üîó\n\n"
        
        
        "üè¢ <b>–ë–∏–∑–Ω–µ—Å—ã:</b>\n\n"
        "/mybiz ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –±–∏–∑–Ω–µ—Å—ã üè¢\n"
        "/biz ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–∏–∑–Ω–µ—Å—ã üìä\n"
        "/buybiz ‚Äî –∫—É–ø–∏—Ç—å –±–∏–∑–Ω–µ—Å üíº\n"
        "/upbiz ‚Äî —É–ª—É—á—à–∏—Ç—å –±–∏–∑–Ω–µ—Å ‚¨ÜÔ∏è\n"
        "/sellbiz ‚Äî –ø—Ä–æ–¥–∞—Ç—å –±–∏–∑–Ω–µ—Å üí∏\n"
        "/collectbiz ‚Äî —Å–æ–±—Ä–∞—Ç—å –ø—Ä–∏–±—ã–ª—å —Å –±–∏–∑–Ω–µ—Å–∞ üíµ\n\n"
        
        "üë∑ <b>–†–∞–±–æ—Ç–∞:</b>\n\n"
        "/avjobs ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–±–æ—Ç—ã üìã\n"
        "/getjob ‚Äî —É—Å—Ç—Ä–æ–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç—É üëî\n"
        "/myjob ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â—É—é —Ä–∞–±–æ—Ç—É üë∑\n"
        "/collectjob ‚Äî —Å–æ–±—Ä–∞—Ç—å –¥–æ—Ö–æ–¥ —Å —Ä–∞–±–æ—Ç—ã üí∞\n"
        "/quitjob ‚Äî —É–≤–æ–ª–∏—Ç—å—Å—è —Å —Ä–∞–±–æ—Ç—ã üö™\n\n"
        
        "üè¶ <b>–ë–∞–Ω–∫ –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏:</b>\n\n"
        "/bankdep ‚Äî –ø–æ–ª–æ–∂–∏—Ç—å –¥–µ–Ω—å–≥–∏ –≤ –±–∞–Ω–∫ üí≥\n"
        "/bankwith ‚Äî —Å–Ω—è—Ç—å –¥–µ–Ω—å–≥–∏ —Å –±–∞–Ω–∫–∞ üíµ\n"
        "/invest1, /invest2, /invest3, /invest4, /invest5 ‚Äî –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç—ã üìà\n"
        "/claiminvest ‚Äî –∑–∞–±—Ä–∞—Ç—å –¥–æ—Ö–æ–¥ —Å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π üíπ\n\n"
        
        "üöó <b>–ê–≤—Ç–æ–º–æ–±–∏–ª–∏:</b>\n\n"
        "/cars ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ üöó\n"
        "/buycar ‚Äî –∫—É–ø–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å üõí\n"
        "/sellcar ‚Äî –ø—Ä–æ–¥–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å üí∏\n\n"
        
        "üè† <b>–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å:</b>\n\n"
        "/houses ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∂–∏–ª—å–µ üè†\n"
        "/buyhouse ‚Äî –∫—É–ø–∏—Ç—å –∂–∏–ª—å–µ üõí\n"
        "/sellhouse ‚Äî –ø—Ä–æ–¥–∞—Ç—å –∂–∏–ª—å–µ üí∏\n\n"
        
        "üõ•Ô∏è <b>–Ø—Ö—Ç—ã:</b>\n\n"
        "/yachts ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —è—Ö—Ç—ã üõ•Ô∏è\n"
        "/buyyachts ‚Äî –∫—É–ø–∏—Ç—å —è—Ö—Ç—É üõí\n"
        "/sellyachts ‚Äî –ø—Ä–æ–¥–∞—Ç—å —è—Ö—Ç—É üí∏\n\n"

        "<b>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:</b>\n"
        "/feedback '—Å–æ–æ–±—â–µ–Ω–∏–µ'\n\n"
        "–ú—ã –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ –æ—Ç–≤–µ—Ç–∏–º –Ω–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å.\n\n"

        
        "üí° <b>–°–æ–≤–µ—Ç:</b> –ù–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–æ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã (/daily) –∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É (/–º–æ–π—Ä–µ—Ñ), —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç–∏! üí∏\n\n"
        
        "üöÄ <b>–í–ø–µ—Ä—ë–¥ –∫ —É—Å–ø–µ—Ö—É! –£–¥–∞—á–∏ –≤ –∏–≥—Ä–µ!</b> üöÄ"
    )
    
    # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫—É "–ü—Ä–æ—Ñ–∏–ª—å"
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å", callback_data="profile")]
    ])

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π
    await message.answer(help_text, parse_mode="HTML", reply_markup=keyboard)

async def handle_profile_callback(callback_query: types.CallbackQuery, state: FSMContext):
    await handle_profile(callback_query.message, callback_query.from_user.id)


async def handle_feedback(message: types.Message):
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_message = message.text.replace("/feedback", "").strip()

        if not user_message:
            await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /feedback.")
            return

        user_id = message.from_user.id

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–∫–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        await execute_db_query(
            "INSERT INTO tickets (user_id, message) VALUES (%s, %s)",
            (user_id, user_message)
        )

        await message.answer("‚úÖ –í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞.")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∏–∫–µ—Ç–∞: {e}")
        await message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–æ–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")